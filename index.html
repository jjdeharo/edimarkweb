<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdiMarkWeb: Editor Markdown &harr; HTML con LaTeX</title>

    <!-- Tailwind CSS con el plugin de Tipografía -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

    <!-- Librerías de Markdown y HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turndown/7.1.1/turndown.min.js" defer></script>

    <!-- KaTeX para renderizar fórmulas LaTeX (integrity corregido) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMVIhbGKLCePo231CVQSHcLesaPSub69DVZXucRepAS5rPjer" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" defer></script>
    
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.523.0/dist/umd/lucide.min.js" defer></script>

    <style>
        /* Estilos personalizados sin @apply */
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .editor-pane {
            height: calc(100vh - 12rem); /* Altura ajustada */
            border: 1px solid #d1d5db; border-radius: 0.5rem;
            padding: 1rem; overflow-y: auto; background-color: #ffffff; transition: box-shadow 0.2s;
        }
        .editor-pane:focus { outline: none; box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); }
        #markdown-input, #html-source-view { font-family: 'Fira Code', 'Courier New', monospace; font-size: 14px; line-height: 1.6; }
        #html-output { font-family: 'Inter', sans-serif; }
        .toolbar-btn, .copy-btn {
            padding: 0.5rem; border-radius: 0.375rem; color: #4b5563;
            transition: background-color 0.2s, color 0.2s;
        }
        .toolbar-btn:hover, .copy-btn:hover { background-color: #e5e7eb; color: #111827; }
        .file-btn {
            padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem;
            font-weight: 500; display: flex; align-items: center; gap: 0.5rem;
            transition: background-color 0.2s;
        }
        
        /* Estilos para la impresión */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="flex flex-wrap justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-gray-800">EdiMarkWeb: Editor Markdown &harr; HTML</h1>
        <div class="flex items-center gap-2 mt-2 sm:mt-0 flex-wrap">
            <button id="open-file-btn" class="file-btn bg-blue-500 text-white hover:bg-blue-600"><i data-lucide="folder-open"></i> Abrir</button>
            <input type="file" id="file-input" class="hidden" accept=".md,.txt,.html">
            <button id="save-btn" class="file-btn bg-green-500 text-white hover:bg-green-600"><i data-lucide="save"></i> Guardar</button>
            <button id="print-btn" class="file-btn bg-gray-600 text-white hover:bg-gray-700"><i data-lucide="printer"></i> Imprimir</button>
        </div>
    </header>

    <!-- Barra de herramientas de formato -->
    <div id="toolbar" class="bg-white p-2 rounded-lg shadow-md mb-4 flex flex-wrap items-center gap-2 border">
        <!-- Grupo 1: Formato básico -->
        <div class="flex items-center gap-1">
            <button class="toolbar-btn" data-format="bold" title="Negrita"><i data-lucide="bold"></i></button>
            <button class="toolbar-btn" data-format="italic" title="Cursiva"><i data-lucide="italic"></i></button>
            <div class="relative" id="heading-dropdown-container">
                <button id="heading-btn" class="toolbar-btn" title="Encabezado"><i data-lucide="heading-1"></i></button>
                <div id="heading-options" class="absolute z-10 -left-2 mt-2 w-40 bg-white rounded-md shadow-lg hidden">
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="heading-1">Título 1</button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="heading-2">Título 2</button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="heading-3">Título 3</button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="heading-4">Título 4</button>
                </div>
            </div>
        </div>
        <div class="border-l h-6 border-gray-300"></div>
        <!-- Grupo 2: Bloques -->
        <div class="flex items-center gap-1">
            <button class="toolbar-btn" data-format="quote" title="Cita"><i data-lucide="quote"></i></button>
            <button class="toolbar-btn" data-format="list-ul" title="Lista"><i data-lucide="list"></i></button>
            <button class="toolbar-btn" data-format="list-ol" title="Lista numerada"><i data-lucide="list-ordered"></i></button>
        </div>
        <div class="border-l h-6 border-gray-300"></div>
        <!-- Grupo 3: Inserciones -->
        <div class="flex items-center gap-1">
            <button class="toolbar-btn" data-format="code" title="Código"><i data-lucide="code-2"></i></button>
            <button class="toolbar-btn" data-format="link" title="Enlace"><i data-lucide="link"></i></button>
            <button class="toolbar-btn" data-format="image" title="Imagen"><i data-lucide="image"></i></button>
            <button class="toolbar-btn" data-format="table" title="Tabla"><i data-lucide="table"></i></button>
        </div>
        <div class="border-l h-6 border-gray-300"></div>
        <!-- Grupo 4: LaTeX -->
        <div class="flex items-center gap-1">
            <button class="toolbar-btn" data-format="latex-inline" title="Fórmula LaTeX (en línea)"><i data-lucide="sigma"></i></button>
            <button class="toolbar-btn" data-format="latex-block" title="Fórmula LaTeX (bloque)"><i data-lucide="function-square"></i></button>
        </div>
        <div class="border-l h-6 border-gray-300"></div>
        <!-- Grupo 5: Pegar -->
        <div class="flex items-center gap-1">
            <button class="toolbar-btn flex items-center gap-1" id="paste-md-btn" title="Pegar Markdown"><i data-lucide="clipboard-paste"></i><span>MD</span></button>
            <button class="toolbar-btn flex items-center gap-1" id="paste-html-btn" title="Pegar HTML"><i data-lucide="clipboard-paste"></i><span>HTML</span></button>
        </div>
    </div>

    <!-- Paneles del editor -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-semibold text-gray-700">Markdown</h2>
                <button id="copy-md-btn" class="copy-btn" title="Copiar Markdown"><i data-lucide="copy"></i></button>
            </div>
            <textarea id="markdown-input" class="editor-pane w-full"></textarea>
        </div>
        <div>
            <!-- Cabecera del panel derecho con interruptor de vista (NUEVO) -->
            <div class="flex justify-between items-center mb-2">
                <h2 id="html-panel-title" class="text-lg font-semibold text-gray-700">Previsualización</h2>
                <div class="flex items-center gap-2">
                    <button id="view-toggle-btn" class="toolbar-btn" title="Cambiar a vista de código">
                        <i data-lucide="code-2"></i>
                    </button>
                    <button id="copy-html-btn" class="copy-btn" title="Copiar HTML"><i data-lucide="copy"></i></button>
                </div>
            </div>
            <div id="html-output" contenteditable="true" class="editor-pane w-full prose max-w-none"></div>
            <textarea id="html-source-view" class="editor-pane w-full hidden"></textarea>
        </div>
    </div>

    <!-- Contenedor para impresión -->
    <div id="print-area" class="hidden prose max-w-none"></div>

    <!-- Modales -->
    <div id="table-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">...</div>
    <div id="save-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">...</div>

    <script>
        // Declaración de variables globales
        let turndownService;
        let isUpdating = false;

        const initialContent = `# ¡Bienvenido a EdiMarkWeb! ...`;

        // --- Funciones principales ---
        function updateHtml() {
            if (isUpdating) return;
            isUpdating = true;
            const markdownInput = document.getElementById('markdown-input');
            const htmlOutput = document.getElementById('html-output');
            const htmlSourceView = document.getElementById('html-source-view');

            let markdownText = markdownInput.value;
            markdownText = markdownText.replace(/\\\\/g, '\\\\\\\\');
            markdownText = markdownText.replace(/\\\[/g, '\\\\[').replace(/\\\]/g, '\\\\]');
            markdownText = markdownText.replace(/\\\(/g, '\\\\(').replace(/\\\)/g, '\\\\)');
            
            if (window.marked) {
                const rawHtml = marked.parse(markdownText);
                htmlOutput.innerHTML = rawHtml;
                htmlSourceView.value = rawHtml;
            }

            try {
                if (window.renderMathInElement) {
                    renderMathInElement(htmlOutput, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true}, {left: '\\[', right: '\\]', display: true},
                            {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}
                        ], throwOnError: false
                    });
                }
            } catch (error) { console.warn("KaTeX no está listo.", error); }
            isUpdating = false;
        }

        function updateMarkdown() {
            if (isUpdating) return;
            isUpdating = true;
            const markdownInput = document.getElementById('markdown-input');
            const htmlOutput = document.getElementById('html-output');
            if (turndownService) {
                markdownInput.value = turndownService.turndown(htmlOutput.innerHTML);
            }
            isUpdating = false;
        }

        function applyFormat(format) {
            // ... (código sin cambios)
        }

        function toggleTableModal(show) { /* ... */ }
        function toggleSaveModal(show) { /* ... */ }
        function saveFile(filename, content, type) { /* ... */ }
        function copyToClipboard(text, btn) { /* ... */ }

        // Carga inicial
        window.onload = () => {
            // Inicialización de elementos del DOM
            const markdownInput = document.getElementById('markdown-input');
            const htmlOutput = document.getElementById('html-output');
            const htmlSourceView = document.getElementById('html-source-view');
            const viewToggleBtn = document.getElementById('view-toggle-btn');
            const htmlPanelTitle = document.getElementById('html-panel-title');
            // ... (resto de elementos del DOM)

            // Inicialización de librerías
            if (window.TurndownService) {
                turndownService = new TurndownService({ headingStyle: 'atx', codeBlockStyle: 'fenced' });
            }

            // Asignación de eventos
            markdownInput.addEventListener('input', updateHtml);
            htmlOutput.addEventListener('input', updateMarkdown);
            htmlSourceView.addEventListener('input', () => {
                if (isUpdating) return;
                isUpdating = true;
                htmlOutput.innerHTML = htmlSourceView.value;
                updateMarkdown();
                isUpdating = false;
            });

            // Evento del interruptor de vista (NUEVO)
            viewToggleBtn.addEventListener('click', () => {
                const isPreviewVisible = !htmlOutput.classList.contains('hidden');
                htmlOutput.classList.toggle('hidden');
                htmlSourceView.classList.toggle('hidden');

                if (isPreviewVisible) {
                    // Cambiando a vista de código
                    htmlPanelTitle.textContent = 'Código HTML';
                    viewToggleBtn.title = 'Cambiar a previsualización';
                    viewToggleBtn.innerHTML = '<i data-lucide="eye"></i>';
                } else {
                    // Cambiando a previsualización
                    htmlPanelTitle.textContent = 'Previsualización';
                    viewToggleBtn.title = 'Cambiar a vista de código';
                    viewToggleBtn.innerHTML = '<i data-lucide="code-2"></i>';
                }
                if (window.lucide) {
                    lucide.createIcons();
                }
            });

            // Evento para enlaces clicables
            htmlOutput.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link && link.href) {
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        window.open(link.href, '_blank', 'noopener,noreferrer');
                    }
                }
            });
            
            // ... (resto de asignaciones de eventos)

            // Carga final
            if (window.lucide) {
                lucide.createIcons();
            }
            markdownInput.value = initialContent;
            updateHtml();
            markdownInput.focus();
        };
    </script>
</body>
</html>

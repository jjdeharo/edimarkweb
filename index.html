<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Markdown &harr; HTML con DOCX y LaTeX</title>

    <!-- Tailwind CSS con el plugin de Tipografía -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

    <!-- Marked.js para convertir Markdown a HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Turndown para convertir HTML a Markdown -->
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>

    <!-- KaTeX para renderizar fórmulas LaTeX (CORREGIDO) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMVIhbGKLCePo231CVQSHcLesaPSub69DVZXucRepAS5rPjer" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    
    <!-- Librerías para DOCX -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.7.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-to-docx@1.8.0/dist/html-to-docx.js"></script>

    <!-- Lucide Icons para los iconos de la barra de herramientas -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Estilos personalizados */
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .editor-pane {
            height: calc(100vh - 12rem); border: 1px solid #d1d5db; border-radius: 0.5rem;
            padding: 1rem; overflow-y: auto; background-color: #ffffff; transition: box-shadow 0.2s;
        }
        .editor-pane:focus { outline: none; box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); }
        #markdown-input { font-family: 'Fira Code', 'Courier New', monospace; font-size: 14px; line-height: 1.6; }
        #html-output { font-family: 'Inter', sans-serif; }
        .toolbar-btn, .copy-btn { @apply p-2 rounded-md text-gray-600 hover:bg-gray-200 hover:text-gray-900 transition-colors; }
        .file-btn { @apply px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2; }
        
        /* Estilos para la impresión */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="flex flex-wrap justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-gray-800">Editor Markdown &harr; HTML</h1>
        <div class="flex items-center gap-2 mt-2 sm:mt-0 flex-wrap">
            <button id="open-file-btn" class="file-btn bg-blue-500 text-white hover:bg-blue-600"><i data-lucide="folder-open"></i> Abrir</button>
            <input type="file" id="file-input" class="hidden" accept=".md,.txt,.html,.docx">
            <button id="save-md-btn" class="file-btn bg-green-500 text-white hover:bg-green-600"><i data-lucide="save"></i> Guardar .md</button>
            <button id="save-html-btn" class="file-btn bg-green-500 text-white hover:bg-green-600"><i data-lucide="save"></i> Guardar .html</button>
            <button id="save-docx-btn" class="file-btn bg-indigo-500 text-white hover:bg-indigo-600"><i data-lucide="file-text"></i> Guardar .docx</button>
            <button id="print-btn" class="file-btn bg-gray-600 text-white hover:bg-gray-700"><i data-lucide="printer"></i> Imprimir</button>
        </div>
    </header>

    <!-- Barra de herramientas de formato -->
    <div id="toolbar" class="bg-white p-2 rounded-lg shadow-md mb-4 flex flex-wrap items-center gap-2 border">
        <!-- Grupo 1: Formato básico -->
        <div class="flex items-center gap-1">
            <button class="toolbar-btn" data-format="bold" title="Negrita"><i data-lucide="bold"></i></button>
            <button class="toolbar-btn" data-format="italic" title="Cursiva"><i data-lucide="italic"></i></button>
            <button class="toolbar-btn" data-format="heading" title="Encabezado"><i data-lucide="heading-1"></i></button>
        </div>
        <div class="border-l h-6 border-gray-300"></div>
        <!-- Grupo 2: Bloques -->
        <div class="flex items-center gap-1">
            <button class="toolbar-btn" data-format="quote" title="Cita"><i data-lucide="quote"></i></button>
            <button class="toolbar-btn" data-format="list-ul" title="Lista"><i data-lucide="list"></i></button>
            <button class="toolbar-btn" data-format="list-ol" title="Lista numerada"><i data-lucide="list-ordered"></i></button>
        </div>
        <div class="border-l h-6 border-gray-300"></div>
        <!-- Grupo 3: Inserciones -->
        <div class="flex items-center gap-1">
            <button class="toolbar-btn" data-format="code" title="Código"><i data-lucide="code-2"></i></button>
            <button class="toolbar-btn" data-format="link" title="Enlace"><i data-lucide="link"></i></button>
            <button class="toolbar-btn" data-format="image" title="Imagen"><i data-lucide="image"></i></button>
            <button class="toolbar-btn" data-format="table" title="Tabla"><i data-lucide="table"></i></button>
        </div>
        <div class="border-l h-6 border-gray-300"></div>
        <!-- Grupo 4: LaTeX -->
        <div class="flex items-center gap-1">
            <button class="toolbar-btn" data-format="latex-inline" title="Fórmula LaTeX (en línea)"><i data-lucide="sigma"></i></button>
            <button class="toolbar-btn" data-format="latex-block" title="Fórmula LaTeX (bloque)"><i data-lucide="function-square"></i></button>
        </div>
    </div>

    <!-- Paneles del editor -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-semibold text-gray-700">Markdown</h2>
                <button id="copy-md-btn" class="copy-btn" title="Copiar Markdown"><i data-lucide="copy"></i></button>
            </div>
            <textarea id="markdown-input" class="editor-pane w-full"></textarea>
        </div>
        <div>
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-semibold text-gray-700">HTML (Previsualización)</h2>
                <button id="copy-html-btn" class="copy-btn" title="Copiar HTML"><i data-lucide="copy"></i></button>
            </div>
            <div id="html-output" contenteditable="true" class="editor-pane w-full prose max-w-none"></div>
        </div>
    </div>

    <!-- Contenedor para impresión -->
    <div id="print-area" class="hidden prose max-w-none"></div>

    <!-- Modal para crear tabla -->
    <div id="table-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div id="table-modal" class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Crear tabla</h3>
            <div class="space-y-4">
                <div>
                    <label for="table-cols" class="block text-sm font-medium text-gray-700">Columnas</label>
                    <input type="number" id="table-cols" value="3" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="table-rows" class="block text-sm font-medium text-gray-700">Filas (de datos)</label>
                    <input type="number" id="table-rows" value="2" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-table-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="create-table-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Crear</button>
            </div>
        </div>
    </div>


    <script>
        // Inicialización de elementos del DOM
        const markdownInput = document.getElementById('markdown-input');
        const htmlOutput = document.getElementById('html-output');
        const printArea = document.getElementById('print-area');
        const toolbar = document.getElementById('toolbar');
        const openFileBtn = document.getElementById('open-file-btn');
        const fileInput = document.getElementById('file-input');
        const saveMdBtn = document.getElementById('save-md-btn');
        const saveHtmlBtn = document.getElementById('save-html-btn');
        const saveDocxBtn = document.getElementById('save-docx-btn');
        const printBtn = document.getElementById('print-btn');
        const copyMdBtn = document.getElementById('copy-md-btn');
        const copyHtmlBtn = document.getElementById('copy-html-btn');
        const tableModalOverlay = document.getElementById('table-modal-overlay');
        const createTableBtn = document.getElementById('create-table-btn');
        const cancelTableBtn = document.getElementById('cancel-table-btn');
        const tableColsInput = document.getElementById('table-cols');
        const tableRowsInput = document.getElementById('table-rows');

        // Inicialización de librerías
        const turndownService = new TurndownService({ headingStyle: 'atx', codeBlockStyle: 'fenced' });
        let isUpdating = false;

        const initialContent = `# ¡Bienvenido al editor!

## Barra de herramientas organizada
He agrupado los botones por función para que sea más fácil encontrarlos.

## Fórmulas LaTeX (Corregido)
Las matrices se ven como deben. Puedes usar \`\\\\\` para los saltos de línea.

### Matriz
\\[
A = \\begin{pmatrix}
a & b \\\\
c & d
\\end{pmatrix}
\\]
`;

        // --- Funciones principales ---
        function updateHtml() {
            if (isUpdating) return;
            isUpdating = true;
            let markdownText = markdownInput.value;
            markdownText = markdownText.replace(/\\\\/g, '\\\\\\\\');
            markdownText = markdownText.replace(/\\\[/g, '\\\\[').replace(/\\\]/g, '\\\\]');
            markdownText = markdownText.replace(/\\\(/g, '\\\\(').replace(/\\\)/g, '\\\\)');
            htmlOutput.innerHTML = marked.parse(markdownText);
            try {
                renderMathInElement(htmlOutput, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true}, {left: '\\[', right: '\\]', display: true},
                        {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}
                    ], throwOnError: false
                });
            } catch (error) { console.warn("KaTeX no está listo.", error); }
            isUpdating = false;
        }

        function updateMarkdown() {
            if (isUpdating) return;
            isUpdating = true;
            markdownInput.value = turndownService.turndown(htmlOutput.innerHTML);
            isUpdating = false;
        }

        markdownInput.addEventListener('input', updateHtml);
        htmlOutput.addEventListener('input', updateMarkdown);

        // --- Barra de herramientas ---
        toolbar.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.format) { applyFormat(button.dataset.format); }
        });

        function applyFormat(format) {
            const start = markdownInput.selectionStart;
            const end = markdownInput.selectionEnd;
            const selectedText = markdownInput.value.substring(start, end);
            let newText = '';
            switch (format) {
                case 'bold': newText = `**${selectedText || 'texto en negrita'}**`; break;
                case 'italic': newText = `*${selectedText || 'texto en cursiva'}*`; break;
                case 'heading': newText = `\n## ${selectedText || 'Encabezado'}\n`; break;
                case 'quote': newText = `\n> ${selectedText || 'Cita'}\n`; break;
                case 'list-ul': newText = `\n- ${selectedText || 'Elemento 1'}\n- Elemento 2`; break;
                case 'list-ol': newText = `\n1. ${selectedText || 'Elemento 1'}\n2. Elemento 2`; break;
                case 'code': newText = `\`${selectedText || 'código'}\``; break;
                case 'link': newText = `[${selectedText || 'texto del enlace'}](https://www.ejemplo.com)`; break;
                case 'image': newText = `![${selectedText || 'texto alternativo'}](https://via.placeholder.com/150)`; break;
                case 'table': toggleTableModal(true); return;
                case 'latex-inline': newText = `$${selectedText || 'E=mc^2'}$`; break;
                case 'latex-block': newText = `\n\\[\n${selectedText || 'f(x) = x^2'}\n\\]\n`; break;
            }
            markdownInput.setRangeText(newText, start, end, 'select');
            markdownInput.focus();
            updateHtml();
        }

        // --- Funcionalidad del modal de tabla ---
        function toggleTableModal(show) {
            tableModalOverlay.style.display = show ? 'flex' : 'none';
        }

        createTableBtn.addEventListener('click', () => {
            const cols = parseInt(tableColsInput.value, 10) || 2;
            const rows = parseInt(tableRowsInput.value, 10) || 1;
            let tableMd = '\n';
            tableMd += '|';
            for (let i = 1; i <= cols; i++) { tableMd += ` Cabecera ${i} |`; }
            tableMd += '\n|';
            for (let i = 0; i < cols; i++) { tableMd += '------------|'; }
            tableMd += '\n';
            for (let r = 0; r < rows; r++) {
                tableMd += '|';
                for (let c = 0; c < cols; c++) { tableMd += ' Celda      |'; }
                tableMd += '\n';
            }
            const start = markdownInput.selectionStart;
            const end = markdownInput.selectionEnd;
            markdownInput.setRangeText(tableMd, start, end, 'end');
            toggleTableModal(false);
            markdownInput.focus();
            updateHtml();
        });
        cancelTableBtn.addEventListener('click', () => toggleTableModal(false));
        tableModalOverlay.addEventListener('click', (e) => { if (e.target === tableModalOverlay) { toggleTableModal(false); } });

        // --- Funcionalidad de Archivos y Copiar ---
        openFileBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            if (file.name.endsWith('.docx')) {
                reader.onload = (e) => mammoth.convertToHtml({ arrayBuffer: e.target.result }).then(r => { htmlOutput.innerHTML = r.value; updateMarkdown(); }).catch(e => console.error(e));
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = (e) => {
                    if (file.name.endsWith(".html")) { htmlOutput.innerHTML = e.target.result; updateMarkdown(); } 
                    else { markdownInput.value = e.target.result; updateHtml(); }
                };
                reader.readAsText(file);
            }
            fileInput.value = '';
        });
        
        function saveFile(filename, content, type) {
            const blob = new Blob([content], { type });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }
        
        saveMdBtn.addEventListener('click', () => saveFile('documento.md', markdownInput.value, 'text/markdown;charset=utf-8'));
        saveHtmlBtn.addEventListener('click', () => saveFile('documento.html', `<!DOCTYPE html><html><head><meta charset="UTF-8"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"></head><body class="prose">${htmlOutput.innerHTML}</body></html>`, 'text/html;charset=utf-8'));
        saveDocxBtn.addEventListener('click', async () => {
            const content = `<div class="prose">${htmlOutput.innerHTML}</div>`;
            const fileBuffer = await htmlToDocx.asBlob(content, { css: `@import url('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css');` });
            saveFile('documento.docx', fileBuffer, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
        });
        
        // --- Función de Copiar (CORREGIDA) ---
        function copyToClipboard(text, btn) {
            const originalIcon = btn.innerHTML;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.style.position = 'fixed';
            tempTextArea.style.top = '-9999px';
            tempTextArea.style.left = '-9999px';
            tempTextArea.value = text;
            document.body.appendChild(tempTextArea);
            tempTextArea.focus();
            tempTextArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    btn.innerHTML = '<i data-lucide="check" class="text-green-500"></i>';
                } else {
                    btn.innerHTML = '<i data-lucide="x" class="text-red-500"></i>';
                }
            } catch (err) {
                console.error('Error al intentar copiar:', err);
                btn.innerHTML = '<i data-lucide="x" class="text-red-500"></i>';
            }

            document.body.removeChild(tempTextArea);
            lucide.createIcons();
            
            setTimeout(() => {
                btn.innerHTML = originalIcon;
                lucide.createIcons();
            }, 2000);
        }
        
        copyMdBtn.addEventListener('click', () => copyToClipboard(markdownInput.value, copyMdBtn));
        copyHtmlBtn.addEventListener('click', () => copyToClipboard(htmlOutput.innerHTML, copyHtmlBtn));
        
        printBtn.addEventListener('click', () => {
            printArea.innerHTML = htmlOutput.innerHTML;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
        });

        // Carga inicial
        window.onload = () => {
            lucide.createIcons();
            markdownInput.value = initialContent;
            updateHtml();
            markdownInput.focus();
        };
    </script>
</body>
</html>

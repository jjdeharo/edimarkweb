<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conversor de markdown a ODT</title>
  <!-- External libraries -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- MathJax with MathML output -->
  <script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f4f4f4;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0.2rem 0;
      font-size: 1.25rem;
    }
    .lang-switch button {
      margin-left: 0.25rem;
      border: 1px solid #ccc;
      background: #fff;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      border-radius: 0.25rem;
    }
    .lang-switch button.active {
      background: #007bff;
      color: #fff;
      font-weight: bold;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }
    textarea {
      width: 100%;
      min-height: 40vh;
      resize: vertical;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 0.25rem;
      margin-bottom: 0.75rem;
      font-family: Consolas, "Courier New", monospace;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .actions button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      background: #007bff;
      color: #fff;
    }
    .actions button[disabled] {
      background: #aaa;
      cursor: not-allowed;
    }
    #status {
      margin-top: 0.5rem;
      font-style: italic;
    }
    footer {
      text-align: center;
      padding: 1rem 0.5rem;
      background: #f4f4f4;
      font-size: 0.875rem;
    }
    footer a {
      color: inherit;
      text-decoration: underline;
    }
    @media (min-width: 768px) {
      main {
        flex-direction: row;
        gap: 1rem;
      }
      textarea {
        width: 50%;
      }
      .right-panel {
        width: 50%;
        display: flex;
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="app-title">Conversor de Markdown a ODT</h1>
    <div class="lang-switch">
      <button id="btn-es">ES</button>
      <button id="btn-ca">CA</button>
    </div>
  </header>

  <main>
    <textarea id="markdown-input" placeholder="# Título\n\nEscribe tu texto en Markdown aquí...\n\nFórmula inline: $E = mc^2$\n\n$$\n\\int_a^b f(x)\,dx\n$$"></textarea>

    <div class="right-panel">
      <div class="actions">
        <button id="convert-btn">Convertir</button>
        <button id="download-btn" disabled>Descargar ODT</button>
      </div>
      <p id="status"></p>
    </div>
  </main>

  <footer>
    <div id="footer-lab"><a href="https://labia.tiddlyhost.com" target="_blank" rel="noopener">Laboratorio de aplicaciones educativas</a></div>
    <div id="footer-made"><a href="https://bilateria.org" target="_blank" rel="noopener">Aplicación hecha por Juan José de Haro</a></div>
    <div id="footer-license"><a href="https://creativecommons.org/licenses/by-sa/4.0/deed.es" target="_blank" rel="noopener">Esta obra está bajo una licencia Creative Commons BY-SA</a></div>
  </footer>

  <script>
    // Simple i18n object
    const i18n = {
      es: {
        title: 'Conversor de Markdown a ODT',
        placeholder: '# Título\n\nEscribe tu texto en Markdown aquí...',
        convert: 'Convertir',
        download: 'Descargar ODT',
        converting: 'Convirtiendo...',
        ready: 'Documento listo para descargar',
        error: 'Error durante la conversión',
        lab: 'Laboratorio de aplicaciones educativas',
        made: 'Aplicación hecha por Juan José de Haro',
        license: 'Esta obra está bajo una licencia Creative Commons BY-SA',
        licenseLink: 'https://creativecommons.org/licenses/by-sa/4.0/deed.es'
      },
      ca: {
        title: 'Convertidor de Markdown a ODT',
        placeholder: '# Títol\n\nEscriu el teu text en Markdown aquí...',
        convert: 'Convertir',
        download: 'Descarregar ODT',
        converting: 'Convertint...',
        ready: 'Document llest per descarregar',
        error: 'S\'ha produït un error durant la conversió',
        lab: "Laboratori d'aplicacions educatives",
        made: 'Aplicació feta per Juan José de Haro',
        license: 'Aquesta obra està sota una llicència Creative Commons BY-SA',
        licenseLink: 'https://creativecommons.org/licenses/by-sa/4.0/deed.ca'
      }
    };

    const langButtons = {
      es: document.getElementById('btn-es'),
      ca: document.getElementById('btn-ca')
    };

    // Detect or load language
    function getInitialLang() {
      const stored = localStorage.getItem('lang');
      if (stored) return stored;
      const navLang = navigator.language || navigator.userLanguage || 'es';
      return navLang.toLowerCase().startsWith('ca') ? 'ca' : 'es';
    }

    let currentLang = getInitialLang();

    function applyLang(lang) {
      currentLang = lang;
      localStorage.setItem('lang', lang);
      document.documentElement.lang = lang;

      // Texts
      document.getElementById('app-title').textContent = i18n[lang].title;
      document.getElementById('markdown-input').placeholder = i18n[lang].placeholder;
      document.getElementById('convert-btn').textContent = i18n[lang].convert;
      document.getElementById('download-btn').textContent = i18n[lang].download;

      // Footer
      document.getElementById('footer-lab').innerHTML = `<a href="https://labia.tiddlyhost.com" target="_blank" rel="noopener">${i18n[lang].lab}</a>`;
      document.getElementById('footer-made').innerHTML = `<a href="https://bilateria.org" target="_blank" rel="noopener">${i18n[lang].made}</a>`;
      document.getElementById('footer-license').innerHTML = `<a href="${i18n[lang].licenseLink}" target="_blank" rel="noopener">${i18n[lang].license}</a>`;

      // Active button styles
      Object.keys(langButtons).forEach(key => {
        langButtons[key].classList.toggle('active', key === lang);
      });
    }

    // Attach language button events
    Object.keys(langButtons).forEach(key => {
      langButtons[key].addEventListener('click', () => applyLang(key));
    });

    applyLang(currentLang);

    // Markdown converter
    const md = window.markdownit({
      html: false,
      breaks: true,
      linkify: true
    });

    // Main conversion function
    async function convertMarkdownToODT() {
      const input = document.getElementById('markdown-input').value;
      const status = document.getElementById('status');
      const downloadBtn = document.getElementById('download-btn');

      status.textContent = i18n[currentLang].converting;
      downloadBtn.disabled = true;

      try {
        // Replace formulas with MathML
        const formulaRegex = /\$\$([\s\S]+?)\$\$|\$([^$]+?)\$/g; // Captures block and inline
        let withMathML = input.replace(formulaRegex, (match, p1, p2) => {
          const tex = p1 || p2;
          try {
            return MathJax.tex2mml(tex);
          } catch (err) {
            console.error('MathJax conversion error', err);
            return tex; // Fallback to raw TeX
          }
        });

        // Convert markdown (with embedded MathML) to HTML
        const html = md.render(withMathML);

        // Very naive HTML -> ODT content.xml mapping
        const bodyLines = html
          .replace(/<\/p>/g, '')
          .split(/<p[^>]*>/g)
          .filter(Boolean)
          .map(line => `<text:p>${line}</text:p>`) // wrap each paragraph
          .join('\n');

        const contentXml = `<?xml version="1.0" encoding="UTF-8"?>\n` +
`<office:document-content xmlns:office="urn:oasis:names:tc:opendocument:xmlns:office:1.0"\n  xmlns:text="urn:oasis:names:tc:opendocument:xmlns:text:1.0"\n  xmlns:math="http://www.w3.org/1998/Math/MathML"\n  office:version="1.3">\n  <office:body>\n    <office:text>${bodyLines}</office:text>\n  </office:body>\n</office:document-content>`;

        const manifestXml = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n` +
`<manifest:manifest xmlns:manifest=\"urn:oasis:names:tc:opendocument:xmlns:manifest:1.0\">\n  <manifest:file-entry manifest:media-type=\"application/vnd.oasis.opendocument.text\" manifest:full-path=\"/\"/>\n  <manifest:file-entry manifest:media-type=\"text/xml\" manifest:full-path=\"content.xml\"/>\n</manifest:manifest>`;

        // Build ODT package
        const zip = new JSZip();
        zip.file('mimetype', 'application/vnd.oasis.opendocument.text', { compression: 'STORE' });
        zip.file('content.xml', contentXml);
        zip.folder('META-INF').file('manifest.xml', manifestXml);

        const blob = await zip.generateAsync({ type: 'blob', mimeType: 'application/vnd.oasis.opendocument.text' });

        // Save blob reference for download
        downloadBtn.blob = blob;
        downloadBtn.disabled = false;
        status.textContent = i18n[currentLang].ready;
      } catch (e) {
        console.error(e);
        status.textContent = i18n[currentLang].error;
      }
    }

    document.getElementById('convert-btn').addEventListener('click', convertMarkdownToODT);

    document.getElementById('download-btn').addEventListener('click', function () {
      if (this.blob) {
        saveAs(this.blob, 'document.odt');
      }
    });
  </script>
</body>
</html>
